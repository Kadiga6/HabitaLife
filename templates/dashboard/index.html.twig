{% extends 'base.html.twig' %}

{% block title %}Tableau de bord - HabitaGo{% endblock %}

{% block body %}
<style>
    /* Modern animations */
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @keyframes slideInLeft {
        from {
            opacity: 0;
            transform: translateX(-30px);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }

    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
    }

    /* Dashboard container */
    .dashboard-container {
        background: linear-gradient(135deg, #f5f7fa 0%, #f0f3f7 100%);
        min-height: 100vh;
        padding: 3rem 0;
    }

    /* Welcome header */
    .welcome-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 3rem 2rem;
        border-radius: 15px;
        margin-bottom: 3rem;
        animation: fadeInUp 0.6s ease-out;
        box-shadow: 0 10px 40px rgba(102, 126, 234, 0.25);
    }

    .welcome-header h1 {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
    }

    .welcome-header p {
        font-size: 1.1rem;
        opacity: 0.95;
    }

    /* Alert modern */
    .alert-modern {
        border: none;
        border-radius: 10px;
        border-left: 5px solid;
        padding: 1.5rem;
        animation: fadeInUp 0.6s ease-out;
        background: white;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
    }

    .alert-modern-warning {
        border-left-color: #ffc107;
        background: linear-gradient(135deg, rgba(255, 193, 7, 0.1), rgba(255, 152, 0, 0.05));
    }

    .alert-modern-warning i {
        color: #ff9800;
        font-size: 1.3rem;
    }

    .alert-modern-warning strong {
        color: #ff9800;
    }

    .alert-modern-warning a {
        color: #ffc107;
        font-weight: 600;
    }

    /* Card modern */
    .card-modern {
        border: none;
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        overflow: hidden;
        animation: fadeInUp 0.6s ease-out;
        height: 100%;
    }

    .card-modern:hover {
        box-shadow: 0 12px 35px rgba(0, 0, 0, 0.15);
        transform: translateY(-8px);
    }

    .card-header-modern {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1.5rem;
        border: none;
        display: flex;
        align-items: center;
        gap: 0.8rem;
    }

    .card-header-modern.primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .card-header-modern.success {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    }

    .card-header-modern.info {
        background: linear-gradient(135deg, #17a2b8 0%, #0dcaf0 100%);
    }

    .card-header-modern.danger {
        background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);
    }

    .card-header-modern h5 {
        margin: 0;
        font-weight: 600;
        font-size: 1.2rem;
    }

    .card-header-modern i {
        font-size: 1.5rem;
    }

    /* Summary stat */
    .stat-summary {
        padding: 2rem;
    }

    .stat-title {
        color: #999;
        font-size: 0.9rem;
        text-transform: uppercase;
        font-weight: 600;
        margin-bottom: 0.5rem;
    }

    .stat-value {
        font-size: 2.2rem;
        font-weight: 700;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 1.5rem;
    }

    .stat-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.8rem 0;
        border-bottom: 1px solid #f0f3f7;
    }

    .stat-item:last-child {
        border-bottom: none;
    }

    .stat-item span {
        color: #666;
        font-size: 0.95rem;
    }

    .stat-item strong {
        font-weight: 600;
        color: #333;
    }

    /* Quick action buttons */
    .quick-actions-card {
        background: white;
        border-radius: 12px;
        padding: 2rem;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    }

    .action-btn {
        border: none;
        border-radius: 10px;
        padding: 1.5rem 1rem;
        font-weight: 600;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.8rem;
        cursor: not-allowed;
        opacity: 0.6;
    }

    .action-btn i {
        font-size: 1.8rem;
    }

    .action-btn:hover {
        transform: translateY(-5px);
    }

    .action-btn.success {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
    }

    .action-btn.danger {
        background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);
        color: white;
    }

    .action-btn.info {
        background: linear-gradient(135deg, #17a2b8 0%, #0dcaf0 100%);
        color: white;
    }

    .action-btn.warning {
        background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);
        color: white;
    }

    /* Incidents list */
    .incident-item {
        padding: 1.2rem 0;
        border-bottom: 1px solid #f0f3f7;
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        transition: all 0.3s ease;
    }

    .incident-item:last-child {
        border-bottom: none;
    }

    .incident-item:hover {
        background: #f9f9f9;
        padding: 1.2rem;
        margin: 0 -1.2rem;
        border-radius: 8px;
    }

    .incident-title {
        font-weight: 600;
        color: #333;
        margin-bottom: 0.3rem;
    }

    .incident-date {
        font-size: 0.85rem;
        color: #999;
    }

    /* Progress bars */
    .progress-stat {
        margin-bottom: 2rem;
    }

    .progress-stat h6 {
        color: #666;
        font-weight: 600;
        margin-bottom: 0.8rem;
        font-size: 0.95rem;
    }

    .progress-stat-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
    }

    .progress-stat-row span {
        color: #666;
        font-size: 0.9rem;
    }

    .progress-stat-row strong {
        color: #333;
        font-weight: 600;
    }

    .progress {
        height: 8px;
        background: #f0f3f7;
        border-radius: 10px;
        overflow: hidden;
        margin-top: 0.5rem;
    }

    .progress-bar {
        background: linear-gradient(90deg, #28a745 0%, #20c997 100%);
        transition: width 0.6s ease;
    }

    /* Badge */
    .badge-modern {
        padding: 0.4rem 0.8rem;
        border-radius: 6px;
        font-size: 0.85rem;
        font-weight: 600;
        display: inline-block;
    }

    .badge-urgente {
        background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);
        color: white;
    }

    .badge-en-cours {
        background: linear-gradient(135deg, #17a2b8 0%, #0dcaf0 100%);
        color: white;
    }

    .badge-en-attente {
        background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);
        color: white;
    }

    .badge-actif {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
    }

    /* Info section */
    .info-section {
        padding: 2rem;
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    }

    .info-item {
        margin-bottom: 2rem;
    }

    .info-item:last-child {
        margin-bottom: 0;
    }

    .info-item strong {
        color: #667eea;
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 600;
    }

    .info-item a {
        color: #667eea;
        text-decoration: none;
        font-weight: 500;
    }

    .info-item a:hover {
        text-decoration: underline;
    }

    /* Container */
    .container-lg {
        max-width: 1200px;
    }

    /* Delays for staggered animation */
    .delay-1 { animation-delay: 0.1s; }
    .delay-2 { animation-delay: 0.2s; }
    .delay-3 { animation-delay: 0.3s; }
</style>

<div class="dashboard-container">
    <div class="container-lg">
        {# Welcome header #}
        <div class="welcome-header">
            <h1>Bonjour, {{ app.user.prenom }} ! ðŸ‘‹</h1>
            <p>Bienvenue sur votre espace locataire HabitaGo</p>
        </div>

        {# Alert #}
        <div class="row mb-4">
            <div class="col-12">
                <div class="alert-modern alert-modern-warning d-flex align-items-center" role="alert">
                    <i class="bi bi-exclamation-triangle-fill"></i>
                    <div style="flex: 1;">
                        <strong>Attention :</strong> Votre loyer de Janvier 2026 est en attente de paiement. Date limite : 05/01/2026
                        <a href="/payments" class="ms-3">Voir les paiements â†’</a>
                    </div>
                </div>
            </div>
        </div>

        {# Summary cards #}
        <div class="row g-4 mb-5">
            <div class="col-md-6 col-lg-4">
                <div class="card-modern delay-1">
                    <div class="card-header-modern primary">
                        <i class="bi bi-cash-coin"></i>
                        <h5>Paiements</h5>
                    </div>
                    <div class="stat-summary">
                        <p class="stat-title">Montant du loyer</p>
                        {% if contrat %}
                            <div class="stat-value">{{ contrat.montantLoyer|number_format(2, ',', ' ') }} â‚¬</div>
                        {% else %}
                            <div class="stat-value text-muted">â€”</div>
                        {% endif %}
                  
                        <div class="stat-item">
                            <span class="text-success">PayÃ©s :</span>
                           <strong>{{ paiementsPayes|default([])|length }}</strong>
                        </div>
                        <div class="stat-item">
                            <span class="text-danger">En retard :</span>
                            <strong>{{ paiementsPayes|default([])|length }}</strong>
                        </div>
                        <a href="{{ path('payments_index') }}"
   class="btn btn-sm w-100"
   style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
    <i class="bi bi-arrow-right-circle me-2"></i>
    Voir lâ€™historique
</a>
                    </div>
                </div>
            </div>

            <div class="col-md-6 col-lg-4">
                <div class="card-modern delay-2">
                    <div class="card-header-modern info">
                        <i class="bi bi-lightning-charge"></i>
                        <h5>Consommations</h5>
                    </div>
                    <div class="stat-summary">
                        <p class="stat-title">Mois actuel</p>
                        <div class="stat-value">DÃ©tails â†’</div>
                        {% if totauxConsommation %}
                            <div class="stat-item">
                                <span><i class="bi bi-lightning text-warning"></i> Ã‰lectricitÃ© :</span>
                                <strong>{{ totauxConsommation.electricite|number_format(2, ',', ' ') }} kWh</strong>
                            </div>
                            <div class="stat-item">
                                <span><i class="bi bi-droplet text-primary"></i> Eau :</span>
                                <strong>{{ totauxConsommation.eau|number_format(2, ',', ' ') }} mÂ³</strong>
                            </div>
                            <div class="stat-item">
                                <span><i class="bi bi-fire text-danger"></i> Gaz :</span>
                                <strong>{{ totauxConsommation.gaz|number_format(2, ',', ' ') }} kWh</strong>
                            </div>
                        {% else %}
                            <div class="stat-item">
                                <span class="text-muted">Aucune donnÃ©e disponible</span>
                            </div>
                        {% endif %}
                        <a href="{{ path('consumption') }}" class="btn btn-sm w-100" style="background: linear-gradient(135deg, #17a2b8 0%, #0dcaf0 100%); color: white; border: none; border-radius: 8px; margin-top: 1rem; font-weight: 600;">
                            <i class="bi bi-arrow-right-circle me-2"></i> Voir les dÃ©tails
                        </a>
                    </div>
                </div>
            </div>

            <div class="col-md-6 col-lg-4">
                <div class="card-modern delay-3">
                    <div class="card-header-modern danger">
                        <i class="bi bi-tools"></i>
                        <h5>Incidents</h5>
                    </div>
                    <div class="stat-summary">
                        <p class="stat-title">Ã‰tat actuel</p>
                        {% if incidents is defined and incidents|length > 0 %}

                            {% set incidentsNonResolus = incidents|default([])|filter(i => i.dateResolution is null) %}
{% set incidentsResolus = incidents|default([])|filter(i => i.dateResolution is not null) %}

                            <div class="stat-value">{{ incidentsNonResolus|length }} actifs</div>
                            <div class="stat-item">
                                <span class="text-warning">Non rÃ©solus :</span>
                                <strong>{{ incidentsNonResolus|length }}</strong>
                            </div>
                            <div class="stat-item">
                                <span class="text-success">RÃ©solus :</span>
                                <strong>{{ incidentsResolus|length }}</strong>
                            </div>
                            <div class="stat-item">
                                <span class="text-muted">Total :</span>
                                <strong>{{ incidents|length }}</strong>
                            </div>
                        {% else %}
                            <div class="stat-value">0 actifs</div>
                            <div class="stat-item">
                                <span class="text-success"><i class="bi bi-check-circle"></i> Aucun incident</span>
                            </div>
                        {% endif %}
                        <a href="{{ path('issues') }}" class="btn btn-sm w-100" style="background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%); color: white; border: none; border-radius: 8px; margin-top: 1rem; font-weight: 600;">
                            <i class="bi bi-arrow-right-circle me-2"></i> GÃ©rer les incidents
                        </a>
                    </div>
                </div>
            </div>
        </div>

        {# Quick actions #}
      <div class="row mb-5">
    <div class="col-12">
        <div class="quick-actions-card">
            <div style="margin-bottom: 1.5rem;">
                <h5 style="color: #333; font-weight: 700; display: flex; align-items: center; gap: 0.8rem; margin: 0;">
                    <i class="bi bi-lightning-fill"></i>
                    Actions rapides
                </h5>
            </div>

            <div class="row g-3">

                <!-- Payer mon loyer -->
                <div class="col-md-3">
                    <a href="{{ path('payments_index') }}"
                       class="action-btn success w-100"
                       style="text-decoration: none; cursor: pointer;">
                        <i class="bi bi-credit-card"></i>
                        <span>Payer mon loyer</span>
                    </a>
                </div>

                <!-- DÃ©clarer un incident -->
                <div class="col-md-3">
                    <a href="{{ path('issues_new') }}"
                       class="action-btn danger w-100"
                       style="text-decoration: none; cursor: pointer;">
                        <i class="bi bi-plus-circle"></i>
                        <span>DÃ©clarer un incident</span>
                    </a>
                </div>

                <!-- Mes consommations -->
                <div class="col-md-3">
                    <a href="{{ path('consumption') }}"
                       class="action-btn info w-100"
                       style="text-decoration: none; cursor: pointer;">
                        <i class="bi bi-graph-up"></i>
                        <span>Mes consommations</span>
                    </a>
                </div>

                <!-- Historique des incidents -->
                <div class="col-md-3">
                    <a href="{{ path('issues') }}"
                       class="action-btn warning w-100"
                       style="text-decoration: none; cursor: pointer;">
                        <i class="bi bi-tools"></i>
                        <span>Historique des incidents</span>
                    </a>
                </div>

            </div>
        </div>
    </div>
</div>


        {# Incidents and Statistics #}
        <div class="row g-4 mb-5">
            <div class="col-lg-6">
                <div class="card-modern">
                    <div class="card-header-modern danger">
                        <i class="bi bi-exclamation-circle"></i>
                        <h5>Incidents en cours</h5>
                    </div>
                    <div style="padding: 2rem;">
                        {% if incidents is defined and incidents|length > 0 %}
                           {% set incidentsActifs = incidents|filter(i => i.statut == 'en_cours') %}


                            {% if incidentsActifs|length > 0 %}
                                {% for incident in incidentsActifs %}
                                    <div class="incident-item">
                                        <div>
                                            <div class="incident-title">#{{ "%03d"|format(incident.id) }} - {{ incident.titre }}</div>
                                            <div class="incident-date">DÃ©clarÃ© le {{ incident.dateCreation|date('d/m/Y') }}</div>
                                        </div>
                                        {% if incident.priorite == 'urgente' %}
                       <div style="padding: 2rem;">
    {% if incidents is defined and incidents|length > 0 %}
        {# DEBUG: Afficher tous les incidents #}
        {% for incident in incidents %}
            <div style="background: #f0f0f0; padding: 10px; margin: 5px 0; border-radius: 5px;">
                <strong>ID:</strong> {{ incident.id }} | 
                <strong>Statut:</strong> {{ incident.statut }} | 
                <strong>Titre:</strong> {{ incident.titre }}
            </div>
        {% endfor %}
        
        {% set incidentsActifs = incidents|filter(i => i.statut == 'en_cours') %}
        
        {% if incidentsActifs|length > 0 %}
            <!-- Affichage normal -->
            {% for incident in incidentsActifs %}
                <div class="incident-item">
                    <div>
                        <div class="incident-title">#{{ "%03d"|format(incident.id) }} - {{ incident.titre }}</div>
                        <div class="incident-date">DÃ©clarÃ© le {{ incident.dateCreation|date('d/m/Y') }}</div>
                    </div>
                    {% if incident.priorite == 'urgente' %}
                        <span class="badge-modern badge-urgente">Urgente</span>
                    {% elseif incident.priorite == 'haute' %}
                        <span class="badge-modern badge-en-attente">Haute</span>
                    {% else %}
                        <span class="badge-modern badge-en-cours">{{ incident.priorite|capitalize }}</span>
                    {% endif %}
                </div>
            {% endfor %}
        {% else %}
            <div class="text-center py-4">
                <i class="bi bi-check-circle" style="font-size: 2rem; color: #28a745;"></i>
                <p class="text-muted mt-2 mb-0">Aucun incident en cours</p>
            </div>
        {% endif %}
    {% else %}
        <div class="text-center py-4">
            <i class="bi bi-inbox" style="font-size: 2rem; color: #ccc;"></i>
            <p class="text-muted mt-2 mb-0">Aucun incident</p>
        </div>
    {% endif %}
    <a href="{{ path('issues') }}" class="btn btn-sm w-100" style="background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%); color: white; border: none; border-radius: 8px; margin-top: 1.5rem; font-weight: 600;">
        Voir tous les incidents â†’
    </a>
</div>                     <span class="badge-modern badge-urgente">Urgente</span>
                                        {% elseif incident.priorite == 'haute' %}
                                            <span class="badge-modern badge-en-attente">Haute</span>
                                        {% else %}
                                            <span class="badge-modern badge-en-cours">{{ incident.priorite|capitalize }}</span>
                                        {% endif %}
                                    </div>
                                {% endfor %}
                            {% else %}
                                <div class="text-center py-4">
                                    <i class="bi bi-check-circle" style="font-size: 2rem; color: #28a745;"></i>
                                    <p class="text-muted mt-2 mb-0">Aucun incident en cours</p>
                                </div>
                            {% endif %}
                        {% else %}
                            <div class="text-center py-4">
                                <i class="bi bi-inbox" style="font-size: 2rem; color: #ccc;"></i>
                                <p class="text-muted mt-2 mb-0">Aucun incident</p>
                            </div>
                        {% endif %}
                        <a href="{{ path('issues') }}" class="btn btn-sm w-100" style="background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%); color: white; border: none; border-radius: 8px; margin-top: 1.5rem; font-weight: 600;">
                            Voir tous les incidents â†’
                        </a>
                    </div>
                </div>
            </div>

            <div class="col-lg-6">
                <div class="card-modern">
                    <div class="card-header-modern success">
                        <i class="bi bi-graph-up"></i>
                        <h5>Statistiques</h5>
                    </div>
                    <div style="padding: 2rem;">
                        <div class="progress-stat">
                            <h6>Consommation d'Ã©nergie</h6>
                            <div class="progress-stat-row">
                                <span>Performance :</span>
                                <strong style="color: #28a745;">-15% vs mois dernier</strong>
                            </div>
                            <div class="progress">
                                <div class="progress-bar" role="progressbar" style="width: 70%; background: linear-gradient(90deg, #28a745 0%, #20c997 100%);"></div>
                            </div>
                            <small style="color: #28a745; display: block; margin-top: 0.5rem;"><i class="bi bi-arrow-down"></i> Excellente performance !</small>
                        </div>

                        <div class="progress-stat">
                            <h6>Historique de paiements</h6>
                            <div class="progress-stat-row">
                                <span>Taux de paiement Ã  temps :</span>
                                <strong style="color: #28a745;">100%</strong>
                            </div>
                            <div class="progress">
                                <div class="progress-bar" role="progressbar" style="width: 100%; background: linear-gradient(90deg, #28a745 0%, #20c997 100%);"></div>
                            </div>
                        </div>

                        <div class="progress-stat">
                            <h6>Temps de rÃ©solution des incidents</h6>
                            <div class="progress-stat-row">
                                <span>Moyenne :</span>
                                <strong>3.2 jours</strong>
                            </div>
                            <div class="progress">
                                <div class="progress-bar" role="progressbar" style="width: 85%; background: linear-gradient(90deg, #17a2b8 0%, #0dcaf0 100%);"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {# Housing info #}
        <div class="row">
            <div class="col-12">
                <div class="card-modern">
                    <div class="card-header-modern" style="background: linear-gradient(135deg, #6c757d 0%, #495057 100%);">
                        <i class="bi bi-house-door"></i>
                        <h5>Informations de votre logement</h5>
                    </div>
                   <div class="info-section">
    <div class="row">

        {# ================= ADRESSE ================= #}
       <div class="col-md-4">
    <div class="info-item">
        <strong>Adresse :</strong><br>

        {% if logement %}
            {{ logement.adresse }}<br>
            {{ logement.codePostal }} {{ logement.ville }}
        {% else %}
            <span class="text-muted">Aucun logement associÃ©</span>
        {% endif %}
    </div>
</div>

{# ================= TYPE DE LOGEMENT ================= #}
<div class="col-md-4">
    <div class="info-item">
        <strong>Type :</strong><br>

        {% if logement %}
            {{ logement.typeLogement }}
        {% else %}
            <span class="text-muted">â€”</span>
        {% endif %}
    </div>
</div>

        {# ================= CONTRAT / BAIL ================= #}
     <div class="col-md-4">
    <div class="info-item">
        <strong>Bail :</strong><br>

        {% if contrat %}
            Depuis le {{ contrat.dateDebut|date('d/m/Y') }}<br>

            {% if contrat.statut == 'actif' %}
                <span class="badge-modern badge-actif">Actif</span>
            {% else %}
                <span class="badge-modern badge-inactif">Inactif</span>
            {% endif %}
        {% else %}
            <span class="text-muted">Aucun contrat actif</span>
        {% endif %}
    </div>
</div>

    </div>
</div>

                </div>
            </div>
        </div>
    </div>
</div>

    
</div>
{% endblock %}
