{% extends 'base.html.twig' %}

{% block title %}Incidents - HabitaGo{% endblock %}

{% block body %}
<style>
    .dashboard-container {
        background: linear-gradient(135deg, #f5f7fa 0%, #f0f3f7 100%);
        min-height: 100vh;
        padding: 3rem 0;
    }

    .welcome-header {
        background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);
        color: white;
        padding: 3rem 2rem;
        border-radius: 15px;
        margin-bottom: 3rem;
        box-shadow: 0 10px 40px rgba(220, 53, 69, 0.25);
        animation: slideDown 0.6s ease-out;
    }

    .welcome-header h1 {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
    }

    .welcome-header p {
        font-size: 1.1rem;
        opacity: 0.95;
    }

    .card-modern {
        border: none;
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        overflow: hidden;
        animation: fadeInUp 0.6s ease-out;
    }

    .card-modern:hover {
        box-shadow: 0 12px 35px rgba(0, 0, 0, 0.15);
        transform: translateY(-8px);
    }

    .card-header-modern {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1.5rem;
        border: none;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .card-header-modern.danger {
        background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);
    }

    .card-header-modern h5 {
        margin: 0;
        font-weight: 600;
        font-size: 1.2rem;
    }

    .stat-card {
        padding: 1.5rem;
        border-radius: 12px;
        color: white;
        text-align: center;
        animation: fadeInUp 0.6s ease-out;
        transition: all 0.3s ease;
    }

    .stat-card:hover {
        transform: translateY(-8px);
        box-shadow: 0 12px 35px rgba(0, 0, 0, 0.15);
    }

    .stat-card.in-progress {
        background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);
        box-shadow: 0 4px 20px rgba(255, 152, 0, 0.25);
    }

    .stat-card.resolved {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        box-shadow: 0 4px 20px rgba(40, 167, 69, 0.25);
    }

    .stat-card.total {
        background: linear-gradient(135deg, #17a2b8 0%, #0dcaf0 100%);
        box-shadow: 0 4px 20px rgba(23, 162, 184, 0.25);
    }

    .stat-card h6 {
        font-size: 0.9rem;
        opacity: 0.95;
        margin-bottom: 0.5rem;
        font-weight: 600;
    }

    .stat-card .stat-number {
        font-size: 2.5rem;
        font-weight: 700;
        margin: 0;
    }

    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .table-modern {
        border-collapse: separate;
        border-spacing: 0 8px;
    }

    .table-modern tbody tr {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        transition: all 0.3s ease;
    }

    .table-modern tbody tr:hover {
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
        transform: translateY(-2px);
    }

    .table-modern td {
        padding: 1.25rem !important;
        border: none;
    }

    .table-modern td:first-child {
        border-radius: 8px 0 0 8px;
    }

    .table-modern td:last-child {
        border-radius: 0 8px 8px 0;
    }

    .table-modern thead {
        display: table-header-group;
    }

    .table-modern thead tr {
        background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
        border: none;
        box-shadow: none;
    }

    .table-modern thead th {
        border: none;
        padding: 1.25rem !important;
        font-weight: 600;
        color: #495057;
        border-bottom: 2px solid #e9ecef;
        text-transform: uppercase;
        font-size: 0.85rem;
        letter-spacing: 0.5px;
    }

    .table-modern thead th:first-child {
        border-radius: 8px 0 0 0;
    }

    .table-modern thead th:last-child {
        border-radius: 0 8px 0 0;
    }
</style>

<div class="dashboard-container">
    <div class="container">
        {# Messages flash #}
        {% if app.flashes %}
            {% for type, messages in app.flashes %}
                {% for message in messages %}
                    <div class="alert alert-{{ type == 'success' ? 'success' : 'danger' }} alert-dismissible fade show" role="alert" style="border-radius: 12px; border: none; box-shadow: 0 4px 15px rgba(0,0,0,0.08); margin-bottom: 2rem;">
                        <i class="bi bi-{{ type == 'success' ? 'check-circle' : 'exclamation-triangle' }}"></i> {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            {% endfor %}
        {% endif %}

        {# Welcome header #}
        <div class="welcome-header">
            <h1><i class="bi bi-exclamation-circle"></i> Mes Incidents</h1>
            <p>D√©clarez et suivez les probl√®mes dans votre logement</p>
        </div>

        {# R√©sum√© des incidents #}
        {% set pending = incidents|filter(i => i.dateResolution is null) %}
        {% set resolved = incidents|filter(i => i.dateResolution is not null) %}
        
        <div class="row mb-4 g-3">
            <div class="col-md-6 col-lg-4">
                <div class="stat-card in-progress">
                    <h6>En cours</h6>
                    <p class="stat-number">{{ pending|length }}</p>
                </div>
            </div>
            <div class="col-md-6 col-lg-4">
                <div class="stat-card resolved">
                    <h6>R√©solus</h6>
                    <p class="stat-number">{{ resolved|length }}</p>
                </div>
            </div>
            <div class="col-md-6 col-lg-4">
                <div class="stat-card total">
                    <h6>Total</h6>
                    <p class="stat-number">{{ incidents|length }}</p>
                </div>
            </div>
        </div>

        {# Bouton d√©clarer un incident #}
        <div class="row mb-4">
            <div class="col-12">
                <div class="card-modern">
                    <div class="card-header-modern danger">
                        <h5><i class="bi bi-plus-circle"></i> D√©clarer un nouvel incident</h5>
                        <a href="{{ path('issues_new') }}" class="btn btn-light btn-sm">
                            <i class="bi bi-plus-circle"></i> Nouveau
                        </a>
                    </div>
                    <div class="card-body p-4">
                        {% if contrat %}
                            <p class="text-muted mb-0">
                                <strong>üìç Logement assign√© :</strong><br>
                                {{ contrat.logement.adresse }}<br>
                                {{ contrat.logement.codePostal }} {{ contrat.logement.ville }}
                            </p>
                        {% else %}
                            <div class="alert alert-warning mb-0">
                                <i class="bi bi-exclamation-triangle"></i> 
                                Vous n'avez pas de logement assign√©. Contactez l'administrateur.
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        {# Tableau des incidents #}
        <div class="row mb-4">
            <div class="col-12">
                <div class="card-modern">
                    <div class="card-header-modern">
                        <h5><i class="bi bi-list-ul"></i> Historique des incidents</h5>
                    </div>
                    <div class="card-body p-0">
                        {% if incidents is empty %}
                            <div class="p-5 text-center">
                                <i class="bi bi-inbox" style="font-size: 3rem; color: #ccc;"></i>
                                <p class="text-muted mt-3 mb-0">Vous n'avez pas encore d√©clar√© d'incident. Si vous rencontrez un probl√®me, utilisez le bouton "Nouveau" ci-dessus.</p>
                            </div>
                        {% else %}
                            <div class="table-responsive">
                                <table class="table table-modern mb-0">
                                    <thead>
                                        <tr>
                                            <th>N¬∞</th>
                                            <th>Cat√©gorie</th>
                                            <th>Titre</th>
                                            <th>Priorit√©</th>
                                            <th>Statut</th>
                                            <th>D√©claration</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for incident in incidents %}
                                        <tr>
                                            <td>
                                                <strong>#{{ "%03d"|format(incident.id) }}</strong>
                                            </td>
                                            <td>
                                                {% if incident.categorie == 'plomberie' %}
                                                    <i class="bi bi-droplet text-primary"></i> Plomberie
                                                {% elseif incident.categorie == 'electricite' %}
                                                    <i class="bi bi-lightning text-warning"></i> √âlectricit√©
                                                {% elseif incident.categorie == 'chauffage' %}
                                                    <i class="bi bi-thermometer-half text-danger"></i> Chauffage
                                                {% elseif incident.categorie == 'serrurerie' %}
                                                    <i class="bi bi-key text-secondary"></i> Serrurerie
                                                {% else %}
                                                    <i class="bi bi-tools text-muted"></i> Autre
                                                {% endif %}
                                            </td>
                                            <td>
                                                <strong>{{ incident.titre }}</strong>
                                            </td>
                                            <td>
                                                {% if incident.priorite == 'urgente' %}
                                                    <span class="badge bg-danger">Urgente</span>
                                                {% elseif incident.priorite == 'haute' %}
                                                    <span class="badge bg-warning text-dark">Haute</span>
                                                {% elseif incident.priorite == 'normale' %}
                                                    <span class="badge bg-info">Normale</span>
                                                {% else %}
                                                    <span class="badge bg-secondary">Basse</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if incident.dateResolution is null %}
                                                    <span class="badge bg-warning text-dark"><i class="bi bi-hourglass-split"></i> En cours</span>
                                                {% else %}
                                                    <span class="badge bg-success"><i class="bi bi-check-circle"></i> R√©solu</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {{ incident.dateCreation|date('d/m/Y') }}
                                            </td>
                                            <td>
                                                <a href="{{ path('issues_show', { id: incident.id }) }}" class="btn btn-sm btn-outline-primary">
                                                    <i class="bi bi-eye"></i> D√©tails
                                                </a>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        {# Informations pratiques #}
        <div class="row">
            <div class="col-12">
                <div class="card-modern">
                    <div class="card-header-modern" style="background: linear-gradient(135deg, #17a2b8 0%, #0dcaf0 100%);">
                        <h5><i class="bi bi-info-circle"></i> Informations pratiques</h5>
                    </div>
                    <div class="card-body p-4">
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="fw-bold mb-3">‚è±Ô∏è D√©lais d'intervention :</h6>
                                <ul class="list-unstyled">
                                    <li class="mb-2"><span class="badge bg-danger">Urgente</span> <small>Intervention sous 24h</small></li>
                                    <li class="mb-2"><span class="badge bg-warning text-dark">Haute</span> <small>Intervention sous 48h</small></li>
                                    <li class="mb-2"><span class="badge bg-info">Normale</span> <small>Intervention sous 5 jours</small></li>
                                    <li><span class="badge bg-secondary">Basse</span> <small>Intervention sous 10 jours</small></li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6 class="fw-bold mb-3">üìû Num√©ros d'urgence :</h6>
                                <ul class="list-unstyled">
                                    <li class="mb-2"><strong>Plombier d'urgence :</strong> <code>06 12 34 56 78</code></li>
                                    <li class="mb-2"><strong>√âlectricien d'urgence :</strong> <code>06 23 45 67 89</code></li>
                                    <li><strong>Gardien de l'immeuble :</strong> <code>06 34 56 78 90</code></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
